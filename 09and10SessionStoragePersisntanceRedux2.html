<!doctype html>
<html lang="en">
  	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
		<style>
			code{
				background-color: rgba(0,0,0,.075);
				font-weight: bold;
			}
			.subtitle{
				font-size: 1.3rem;
				font-weight: bold;
				margin: 0;
				padding: 5px;
				margin-top: 5px;
				background-color: rgba(0,0,0,.075);
				text-align: center;
			}
			h3{
				font-size: 2rem;
				font-weight: bold;
				margin: 0;
				padding: 5px;
				margin-top: 10px;
			}
			.paragraph{
				margin: 0.5rem 0 0.5rem;
			}
			.tab{
				margin: 0 1rem;
			}
			html{
				scroll-behavior: smooth;
			}
			</style>

		<title>09 and 10 Session Storage + Persistence and Redux 2</title>
  	</head>
  	<body>
      
    <div class="container">
		<h1 class="display-3 text-center">09 and 10 Session Storage + Persistence and Redux 2<hr></h1>
		<header>
			<p class="paragraph">
				Overall description.
			</p>
		</header>

		<h2 id="00" class="subtitle">Index</h2>
		<table class="table table-striped">
			<thead>
				<tr>
					<th scope="col">#</th>
					<th scope="col">Topic</th>
					<th scope="col">Description</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<th scope="row">1</th>
					<td>
						<a href="#01">topicName</a>
					</td>
					<td>
						<code>Code or description</code>
					</td>
				</tr>
			</tbody>
		</table>

		<ul class="list-group">
			<li class="list-group-item">
				<a id="01" href="#00">Index</a>
				<h2 class="subtitle">Local Storage and Session Storage and Redux-Persist</h2>
				<p class="paragraph">
					We have no data persisntence right now, so if we have a cart and users refresh the page it will be wiped from the state. We still have a user in our state beacause of Firebase, however all the other state gets reset. There are many ways to handle this problem. One is with firebase, but this requires a lot of unnecessary DB handling at the moment. The browser has an internal DB: LocalStorage. There is also a library called <strong>redux-persist</strong>, but we will start using the Browser native solution. I already used local storage and session storage for PWC. Redux persist uses this to set the item in our state using local storage for persistence.
				</p>
				<p class="paragraph">
					<strong>Redux Persist</strong>
					<br>
					We install <code>yarn add redux-persist</code>, which hoepfuly comes with types because I couldn't install them. We then go to our <strong>store.ts</strong> file to implement the setup. We <code>import { persistStore } from 'redux-persist';</code> then we use it on <code>const persistor = persistStore(store)</code> then we <code>export default { store, persistor }</code>. This will create a persistent version of our store through the <code>persistor</code> value in our object. 
				</p>
				<p class="paragraph">
					<strong>root-reducer config</strong>
					<br>
					Now we need to go to our <strong>root-reducer</strong> and <code>import { persistReducer } from 'redux-persist'</code> and <code>import storage form 'redux-presist/lib/storage'</code>. This last import gives use the localStorage object. We could also use sessionStorage, but we would need to change the lib. We want the regular storage. To have our state persist, we need to create a config object. It has 3 kv pairs. <code>key: 'root'</code> this tells form what part of our reducer obejct do want to start storing everything. We set it to start from the root. Then <code>storage,</code> which will store our data wherever the storage value from redux-persist is, and is equivalent to <code>storage: storage</code>. and <code>whitelist: [...]</code> which is an array of string values for the parts of our state that we want to persist. In our combineReducers() we have user and cart, however we are doing persistance for the user in the DB, therefore we don't need it here, so we just do <code>whitelist: ['cart']</code>. Now we have our <code>const persistConfig = { ... }</code> set up. We then need to move our previous export to a new const <code>const rootReducer = combineReducers({ ... })</code> because we need to wrap it around our persistReducer(). We do <code>export default persistReduce(persistConfig, rootReducer)</code> which takes the config as the first arg, and the reducer we want to persist as the second arg. It returns our persisted version of the reducer which is the one we are now using. 
				</p>
				<p class="paragraph">
					<strong>index.tsx</strong>
					<br>
					We <code>import { PersistGate } from "redux-persist/integration/react";</code> which is the implementation for react. There are different directories for different frameworks like React Native and Electron that can leverage Redux and need different imports. We also change the import for store to <code>import { store, persistor }</code> Then we wrap our App Component inside our <code>PersistGate</code> as a component and we pass <code>PersistGate persistor={persistor}</code> and TS is happy. The persistor is the persisted version of our store. We need to keep PersistGate inside of Probider and BrowserRouter so that it can update, react to the routing, and keep persistance. After we have this, now we can put items in our cart and refresh and they persist! yay!
				</p>
				<p class="paragraph">
					<strong>Actions</strong>
					<br>
					In our console, in our logger, we can see a new action <code>type: 'persist/PERSIST'</code> checks wether or not anything exists in our localStorage. And then it executes another action <code>type: 'persist/REHYDRATE'</code> that <em>rehydrates</em> the store with whatever it is we had stored in our prefered means of storage. Now we can see that our cart was updated with the items we had before. So the first action checks localStorage, and the second one updates. We can also see that our state now has a <code>_persist: {}</code> object in it as well. We can also see that when our App launches our State doesn't have this prop, and it is added after the first redux-persist action. If we go to our LocalStorage browser tab we can see that we have the cart under the <code>persist:root</code> key and that our library is in fact using it. 
				</p>
				<a id="02" href="#00">Index</a>
				<h2 class="subtitle">Directory State Into Redux</h2>
				<p class="paragraph">
					Up to now we have done 90% of what we will be doing when developing a React App. We will be refactoring our code to move things we are managing in internal state of our Components into Redux. We start with the Directory Component, which has internal state. We create a new redux/directory/ dir, and then create our <strong>directory-reducer</strong>. We copy the state from the component and set it as <code>const INITIAL_STATE</code> in our reducer. Then we create our reducer <code>const directoryReducer = (state = INITIAL_STATE, action) => { ... }</code> and inside we do just a default switch <code>switch (action.type) { default: return state; }</code> and then we export it.
				</p>
				<p class="paragraph">
					<strong>root-reducer</strong>
					<br>
					I tried out a new type of Typing for this Redux directory, using <code>typeof</code>. I exported our <code>export const INITIAL_STATE</code> and did <code>export type DirectoryState = typeof INITIAL_STATE</code> which gets the type of our const. This saves us from writing a lot of code, and if we change the const it updates automatically. Also, if we need a type for the sections we could do <code>typeof INITIAL_STATE.sections</code> which would get it automatically. I wanted to try this our in the root-reducer and store types. So I removed the export default and <code>export const rootReducer</code> and <code>export const persistRootReducer</code> instead. In my <strong>store.types.ts</strong> I want to inferr the State type using the rootReducer. I found that you can get the Return Type of a Fn in TS. I first <code>import { rootReducer } from './root-reducer';</code> and then <code>export type State = ReturnType&lt;typeof rootReducer>;</code> which will automatically update the State type when we update our rootReducer. I had to modify the import of <strong>index.tsx</strong> but it is minor and much worth the Inferrence.
				</p>
				<p class="paragraph">
					<strong>Direcotry Selectors</strong>
					<br>
					We see that we user our selections in our Component, therefore we need to create <strong>selectors</strong> for it. We create <strong>directory.selectos.ts</strong>. Inside we <code>import { createSelector, Selector } from 'reselect';</code> and the types <code>State</code> and <code>DirectoryState</code>. We start by creating our Selector for the part of the state we want <code>const selectDirectory: Selector&lt;State, DirectoryState> = (state) => state.directory</code> which selects the slice of the state we want for everything directory related. We want the section so we create <code>export const selectDirectorySection = createSelector(selectDirectory, directory => directory.sections</code> which has TS intellisense :3 
				</p>
				<p class="paragraph">
					<strong>Directory Component</strong>
					<br>
					We now do our basic connect() setup, mapStateToProps(), connector(), ConnectedProps, and <code>export default connector(Directory)</code> I converted Directory from a class component to a FC and used DirectoryProps we got from ConnectedProps as the generic and then I <code>({ sections })</code> which allows us to pass down our data to MenuItem. I did 80% of this before the lecture to test, and got it good. Now we can see that <code>directory: { ... }</code> is in our state through the console. 
				</p>
				<a id="03" href="#00">Index</a>
				<h2 class="subtitle">ShopPage into Redux</h2>
				<p class="paragraph">
					Ill do this on my own. 
				</p>
			</li>
		</ul>
	</div>

	<!-- Optional JavaScript -->
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	</body>
</html>